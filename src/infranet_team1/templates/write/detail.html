{% extends "base.html" %}

{% block title %}{{ post.title }} - ì»¤ë®¤ë‹ˆí‹°{% endblock %}

{% block content %}
<div class="container" style="display: flex;">
    <!-- ğŸ”¹ ì™¼ìª½ ì‚¬ì´ë“œë°”: ì¹´í…Œê³ ë¦¬ -->
    <aside class="sidebar" style="width: 200px; margin-right: 20px;">
        <h3>ì¹´í…Œê³ ë¦¬</h3>
        <ul class="category-list">
            <li><a href="{{ url_for('write.home') }}">ì „ì²´ë³´ê¸°</a></li>
            {% for cat in category_list %}
            <li><a href="{{ url_for('write.home', category=cat) }}">{{ cat }}</a></li>
            {% endfor %}
        </ul>
    </aside>

    <!-- ğŸ”¸ ì˜¤ë¥¸ìª½ ë³¸ë¬¸: ê²Œì‹œê¸€ ìƒì„¸ ë° ëŒ“ê¸€ -->
    <main style="flex: 1;">
        <article class="post-detail">
            <h2>{{ post.title }}</h2>
            <p class="meta">
                ì‘ì„±ì: {{ user_name }} | ì‘ì„±ì¼: {{ post.created_at.strftime('%Y-%m-%d %H:%M') }}
                {% if post.updated_at %}
                | ìˆ˜ì •ì¼: {{ post.updated_at.strftime('%Y-%m-%d %H:%M') }}
                {% endif %}
            </p>
            <div class="content">
                <pre>{{ post.content }}</pre>
            </div>

            <div class="post-actions">
                <a href="{{ url_for('write.edit_form', post_id=post._id) }}">ìˆ˜ì •</a>
                <form method="POST" action="{{ url_for('write.delete', post_id=post._id) }}" style="display:inline;">
                    <button type="submit" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                </form>
            </div>
        </article>

        <section class="comments">
            <h3>ëŒ“ê¸€ ({{ post.comments | length }})</h3>
            {% if post.comments %}
            <ul>
                {% for comment in post.comments %}
                <li>
                    <b>{{ author_map[comment.author_id] if comment.author_id in author_map else 'ì•Œ ìˆ˜ ì—†ìŒ' }}</b>
                    <small>{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                    <pre class="small_ui">{{ comment.content }}</pre>

                    {% set is_comment_author = (comment.author_id|string == current_user.id) %}
                    {% set is_post_author = (post.author_id|string == current_user.id) %}
                    {% set is_admin = current_user.role in ['admin', 'system'] %}

                    {% if is_comment_author or is_post_author or is_admin %}
                    <form method="POST" action="{{ url_for('write.delete_comment', post_id=post._id) }}" style="display:inline;">
                        <input type="hidden" name="comment_id" value="{{ comment.comment_id }}">
                        <button type="submit" class="small_ui" onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ëŒ“ê¸€ ì‚­ì œ</button>
                    </form>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}

            <h4>ëŒ“ê¸€ ì‘ì„±</h4>
            <form method="POST" action="{{ url_for('write.add_comment', post_id=post._id) }}">
                <label>ë‚´ìš©:<br/>
                    <textarea name="comment_content" rows="4" required></textarea>
                </label><br/>
                <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
            </form>
        </section>
    </main>
</div>
{% endblock %}
